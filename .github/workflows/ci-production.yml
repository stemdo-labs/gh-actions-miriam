name: CI Workflow for Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    uses: ./.github/workflows/reusable-build.yml
    with:
      node_version: '14'
      environment: 'production'
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

deploy:
  runs-on: ubuntu-latest
  environment:
    name: production
  steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Log in to DockerHub
      uses: ./.github/actions/docker-login

    - name: Pull Docker Image from Production
      run: docker pull my-dockerhub-username/my-angular-app:${{ github.sha }}-prod

    - name: Run Docker Container in Production
      run: docker run -d -p 80:80 my-dockerhub-username/my-angular-app:${{ github.sha }}-prod

    - name: Check Production Deployment
      run: curl http://localhost
